use log::*;

mod logger;

wit_bindgen::generate!({
    world: "plugin-world",
    path: "./wit",
    pub_export_macro: true
});

use crate::exports::rustpress::plugin::event_handler::*;
struct {{plugin_name_pascal}}Plugin;

impl Guest for {{plugin_name_pascal}}Plugin {
    fn handle_filter(event: PluginFilterEvent) -> anyhow::Result<PluginFilterEvent, String> {
        crate::logger::init();

        info!("Processing event for {{plugin_name}} plugin");
        match event {
            PluginFilterEvent::OnPostPublishedFilter(data) => {
                let processed_data = on_post_published(data).map_err(|e| e.to_string())?;
                Ok(PluginFilterEvent::OnPostPublishedFilter(processed_data))
            },
            _ => Ok(event),
        }
    }
    fn handle_action(event: PluginActionEvent) {
        crate::logger::init();

        info!("Processing action for {{plugin_name}} plugin");
        // For now, just log the event
        match event {
            PluginActionEvent::Unknown => {
                // Do nothing for unknown events
            }
        }
    }
}
fn on_post_published(mut post: OnPostPublishedData) -> anyhow::Result<OnPostPublishedData, anyhow::Error> {
    let mut rng = rand::rng();
    let line_index = rand::Rng::random_range(&mut rng, 0..SONNET_LINES.len());
    let poetry_line = SONNET_LINES[line_index];
    post.content = format!("{}\n\n{}", post.content, poetry_line);

    Ok(post)
}
// Static sonnet lines
static SONNET_LINES: &[&str] = &[
    "Shall I compare thee to a summer's day?",
    "Thou art more lovely and more temperate:",
    "Rough winds do shake the darling buds of May,",
    "And summer's lease hath all too short a date;",
    "Sometimes too hot the eye of heaven shines,",
    "And often is his gold complexion dimmed;",
    "And every fair from fair sometime declines,",
    "By chance or nature's changing course untrimmed;",
    "But thy eternal summer shall not fade,",
    "Nor lose possession of that fair thou ow'st;",
    "Nor shall death brag thou wander'st in his shade,",
    "When in eternal lines to time thou grow'st:",
    "So long as men can breathe or eyes can see,",
    "So long lives this, and this gives life to thee.",
];

export!({{plugin_name_pascal}}Plugin);