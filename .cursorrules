# RustPress Project Rules

## Language Requirements

- **All code generated by Cursor AI must be written in English** (comments, variable names, function names, documentation, etc.)
- **All documentation generated by Cursor AI must be written in English** (README files, code comments, API documentation, etc.)
- Exception: User-facing text in the frontend can be in Chinese (as the current frontend uses Chinese for UI text)

## Project Overview

RustPress is a modern, pluggable Content Management System (CMS) built with Rust and React. The project is designed to be extensible, performant, and developer-friendly, with a focus on modularity and plugin architecture.

## Project Structure

```
rustpress/
â”œâ”€â”€ src/                    # Rust backend source code
â”‚   â”œâ”€â”€ api/               # API controllers and routes
â”‚   â”‚   â”œâ”€â”€ admin_api/     # Admin API endpoints (requires admin middleware)
â”‚   â”‚   â”‚   â”œâ”€â”€ admin_controller.rs  # Settings and plugin management
â”‚   â”‚   â”‚   â”œâ”€â”€ user_controller.rs   # User management (ban, reset password)
â”‚   â”‚   â”‚   â””â”€â”€ post_controller.rs   # Post management (admin view, delete)
â”‚   â”‚   â”œâ”€â”€ post_controller.rs   # Post management endpoints
â”‚   â”‚   â”œâ”€â”€ user_controller.rs   # User management endpoints
â”‚   â”‚   â”œâ”€â”€ upload_controller.rs # File upload endpoints
â”‚   â”‚   â”œâ”€â”€ page_controller.rs   # SPA page serving
â”‚   â”‚   â””â”€â”€ routes.rs            # Route configuration
â”‚   â”œâ”€â”€ auth/              # Authentication and authorization
â”‚   â”œâ”€â”€ dto/               # Data Transfer Objects
â”‚   â”œâ”€â”€ entity/            # SeaORM entities (database models)
â”‚   â”œâ”€â”€ repository/        # Data access layer (repository pattern)
â”‚   â”œâ”€â”€ storage/           # Storage backend abstraction
â”‚   â”œâ”€â”€ seed.rs            # Database seeding
â”‚   â””â”€â”€ main.rs            # Application entry point
â”œâ”€â”€ frontend/              # Main React frontend (user-facing blog interface)
â”‚   â””â”€â”€ src/
â”‚       â”œâ”€â”€ components/    # React components
â”‚       â”œâ”€â”€ services/      # API client services
â”‚       â”œâ”€â”€ utils/         # Utility functions
â”‚       â””â”€â”€ types.ts       # TypeScript type definitions
â”œâ”€â”€ admin-frontend/        # Admin React frontend (standalone admin panel)
â”‚   â””â”€â”€ src/
â”‚       â”œâ”€â”€ components/    # Admin components
â”‚       â”œâ”€â”€ services/      # Admin API client
â”‚       â””â”€â”€ types.ts       # Admin TypeScript types
â””â”€â”€ rustpress-migration/   # Standalone database migration tool
    â””â”€â”€ src/
        â”œâ”€â”€ lib.rs         # Migration library
        â””â”€â”€ main.rs        # Migration CLI tool
```

## Technology Stack

### Backend
- **Rust** - Core application language
- **Axum** - Web framework
- **SeaORM** - ORM for database operations
- **PostgreSQL** - Primary database
- **JWT** - Authentication tokens
- **Tokio** - Async runtime

### Frontend
- **React 19** - UI framework
- **TypeScript** - Type safety
- **Tailwind CSS** - Styling
- **Vite** - Build tool
- **React Markdown** - Markdown rendering

## Development Phases & Milestones

### âœ… Phase 1: Core CMS Functionality (Completed)

**Content Management**
- Blog post creation, editing, and deletion
- Markdown support with syntax highlighting
- Category organization
- Draft system with auto-save
- Version history and restoration

**User Management**
- JWT-based authentication
- Role-based access control (Root, Admin, User)
- User profile management
- User banning system (via `banned_at` field)

**Media Management**
- Image upload and storage
- Flexible storage backend (currently local filesystem, extensible to S3)

**Admin Panel**
- Settings management (external registration, maintenance mode)
- User management (view, ban/unban, reset password)
- Post management (view all posts, delete any post)
- Plugin management (enable/disable, reserved for future plugin system)

**API & Documentation**
- RESTful API with OpenAPI/Swagger documentation
- Admin API endpoints at `/api/admin/*` (protected by `admin_middleware`)
- Comprehensive error handling
- Request/response logging

### ðŸš§ Phase 2: Plugin System & AI Integration (Next)

**Plugin Architecture**
- Plugin API design and implementation
- Hot-reloadable plugins
- Plugin lifecycle management
- Inter-plugin communication

**AI Integration**
- AI-powered content generation
- Smart content suggestions
- Automated tagging and categorization
- Content optimization recommendations

### ðŸ”® Phase 3: Plugin Center & Advanced Features (Future)

**Plugin Center**
- Plugin marketplace
- Plugin discovery and installation
- Version management
- Community ratings and reviews

**Advanced Admin Panel**
- Comprehensive dashboard
- System configuration
- Plugin management interface
- Analytics and reporting
- User activity monitoring

**Theme System**
- Customizable frontend themes
- Theme marketplace
- Theme editor and customization tools
- Live preview functionality
- Responsive theme templates

## Key Architectural Patterns

### Repository Pattern (`src/repository/`)
- All database operations go through repository traits
- PostgreSQL-specific implementations in `postgres_repository.rs` and `postgres_user_repository.rs`
- Enables easy testing and swapping database backends

### Middleware Pattern (`src/auth/middleware.rs`)
- `auth_middleware`: Verifies JWT token and extracts user info
- `admin_middleware`: Checks if user has Admin or Root role (must be used after `auth_middleware`)
- Middleware applied at router level, not in individual handlers

### API Structure (`src/api/`)
- Public routes: `/api/health`, `/api/auth/*`, `/api/posts` (GET)
- Protected routes: `/api/posts/*`, `/api/users/*`, `/api/drafts/*`, `/api/upload/*`
- Admin routes (`src/api/admin_api/`): `/api/admin/*` (requires both authentication and admin role)

### Frontend Separation
- **Main Frontend** (`frontend/`): User-facing blog interface (port 5173)
- **Admin Frontend** (`admin-frontend/`): Standalone admin panel (port 5174)
- Both frontends are independent projects with separate build processes

## Database Schema (`src/entity/` and `rustpress-migration/`)

### Entity Files (`src/entity/`)
- **CRITICAL**: All files in `src/entity/` directory MUST be generated by `sea-orm-cli`
- **DO NOT manually modify** files in `src/entity/` directory
- **DO NOT allow AI agents to modify** files in `src/entity/` directory
- To update entities: Modify migration files in `rustpress-migration/src/`, then run `sea-orm-cli generate entity` to regenerate entity files
- Entity files are auto-generated and will be overwritten by sea-orm-cli

### Tables
- `users`: User accounts with roles (Root, Admin, User) and ban status (`banned_at`)
- `posts`: Blog posts with versioning support
- `post_versions`: Version history for posts
- `post_drafts`: Draft system for auto-save
- `settings`: System configuration (key-value pairs)
- `plugins`: Plugin registry (reserved for future plugin system)

### Migrations
- Located in `rustpress-migration/src/`
- Run migrations: `cd rustpress-migration && cargo run`
- Migration files follow pattern: `m{date}_{description}.rs`

## Coding Guidelines

### Rust Backend (`src/`)
- **Rust Edition**: 2024 (as specified in `Cargo.toml`)
- Use async/await for all I/O operations
- Use `Result` types for error handling
- Follow Rust naming conventions (snake_case for functions/variables, PascalCase for types)
- Use SeaORM ActiveModel for database operations
- All admin API handlers should NOT check permissions (handled by `admin_middleware`)

### TypeScript Frontend (`frontend/` and `admin-frontend/`)
- Use TypeScript strict mode
- Define types in `types.ts` files
- Use functional React components with hooks
- Follow React naming conventions (PascalCase for components)

### API Design (`src/api/`)
- RESTful API design
- Use proper HTTP status codes
- All admin endpoints under `/api/admin/*` (implemented in `src/api/admin_api/`)
- Admin endpoints require `admin_middleware` (applied at router level)
- Use OpenAPI annotations (`#[utoipa::path]`) for documentation

## Authentication & Authorization (`src/auth/`)

- **Authentication**: JWT-based with access and refresh tokens
- **Authorization**: Role-based (Root, Admin, User)
- **Admin Routes**: Protected by `admin_middleware` which checks for Admin or Root role
- **Middleware Stack**: `auth_middleware` â†’ `admin_middleware` (for admin routes)

## Important Notes

1. **Admin Middleware**: All `/api/admin/*` routes automatically check admin permissions via `admin_middleware`. Individual handlers in `src/api/admin_api/` should NOT check permissions.

2. **Database Connection**: The `ExtendedAppState` includes both repository instances and a database connection (`db`). Use `get_db_connection()` helper or access `state.db` directly.

3. **Frontend Separation**: Admin frontend (`admin-frontend/`) is completely separate from main frontend (`frontend/`). They share no code and run on different ports.

4. **User Banning**: Users can be banned via `banned_at` field in users table. Admin middleware should check this if needed (currently not enforced at middleware level).

5. **Settings**: System settings stored in `settings` table as key-value pairs. Default values are handled in application code if not present in database.

6. **Plugin System**: Plugin tables and API endpoints exist but are reserved for future implementation. Current code provides the infrastructure.

7. **Entity Files**: Files in `src/entity/` directory are generated by `sea-orm-cli` and MUST NOT be manually modified. To change database schema, create migration files and regenerate entities using `sea-orm-cli generate entity`. AI agents should never modify files in `src/entity/` directory.
